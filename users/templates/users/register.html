{% extends 'base.html' %}

{% load static %}

{% block title %}Veterinaria Pochita{% endblock title %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'styles/style.css' %}">
<style>
    .pet-section {
        display: none;
    }
    
    .nav-buttons {
        display: flex;
        justify-content: space-between;
        margin: 20px 0;
        gap: 2px;
    }
    
    .progress-indicator {
        text-align: center;
        margin-bottom: 20px;
    }
    
    .step {
        display: inline-block;
        margin: 0 5px;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #ddd;
    }
    
    .step.active {
        background: #4070f4;
    }

    
    .nav-buttons button {
        flex: 1;
        min-width: 85px;
        font-size: 12px;
        white-space: nowrap;
        padding: 0 6px;
    }

    .register {
        text-align: center;
        margin-top: 15px;
        width: fit-content;
        margin-left: auto;
        margin-right: auto;
    }

    .register p {
        margin: 0;
        font-size: 0.9em;
    }

    /* File input specific styling */
    .input-field.file-field {
        margin-top: 30px;
    }

    .input-field.file-field label {
        position: absolute;
        top: -25px;
        left: 0;
        color: #ffff;
        font-size: 14px;
    }

    .input-field.file-field input[type="file"] {
        margin-top: 5px;
        padding: 8px 0;
        color: #ffff;
    }

    .register a {
        color: #ffff;
        text-decoration: none;
    }
    
    .register a:hover {
        text-decoration: underline;
    }

    #addPetBtn {
    font-size: 14px;
    min-width: 140px; /* Increased from 120px */
    white-space: nowrap; /* Prevents text wrapping */
    padding: 0 15px; /* Slightly reduced padding */
    }

    .nav-buttons #addPetBtn {
    font-size: 10px !important;
    padding: 0 4px !important;
    min-width: 80px;
    }   

</style>
{% endblock extra_head %}

{% block heading %}{% endblock heading %}

{% block content %}
<div class="wrapper">
    <form method="post" enctype="multipart/form-data" id="registrationForm">
        {% csrf_token %}
        <h2>Registro de Cliente</h2>
        
        <div class="progress-indicator">
            <span class="step active"></span>
            <span class="step"></span>
        </div>

        <!-- User Information Section -->
        <div class="user-section" id="userSection">
            <div class="section-title">
                <h3>Información Personal</h3>
            </div>
            
            <div class="input-field">
                <input type="text" name="username" required>
                <label>Usuario</label>
            </div>
        
            <div class="input-field">
                <input type="email" name="email" required>
                <label>Correo electrónico</label>
            </div>
            
            <div class="input-field">
                <input type="password" name="password1" required>
                <label>Contraseña</label>
            </div>
            
            <div class="input-field">
                <input type="password" name="password2" required>
                <label>Confirmar contraseña</label>
            </div>
            
            <div class="input-field">
                <input type="text" name="name" required>
                <label>Nombre completo</label>
            </div>
            
            <div class="input-field">
                <input type="text" name="phone_number" required>
                <label>Teléfono</label>
            </div>
            
            <div class="input-field">
                <input type="text" name="address" required>
                <label>Dirección</label>
            </div>

            <div class="nav-buttons">
                    <button type="button" id="nextBtn">Siguiente</button>
            </div>
        </div>

        <!-- Pet Information Section -->
        <div class="pet-section" id="petSection">
            <div class="section-title">
                <h3>Información de la Mascota</h3>
            </div>

            <div class="input-field">
                <input type="text" name="pet_name" required>
                <label>Nombre de la mascota</label>
            </div>

            <div class="input-field">
                <input type="text" name="species" required>
                <label>Especie</label>
            </div>

            <div class="input-field">
                <input type="text" name="breed" required>
                <label>Raza</label>
            </div>

            <div class="input-field">
                <input type="number" name="age" required min="0">
                <label>Edad</label>
            </div>

            <div class="input-field file-field">
                <label>Foto de la mascota</label>
                <input type="file" name="image" accept="image/*">
            </div>

            <div class="nav-buttons">
                <button type="button" id="prevBtn">Anterior</button>
                <button type="button" id="addPetBtn">Añadir otra mascota</button>
                <button type="submit">Registrarse</button>
            </div>
        </div>
        <div class="register">
            <p>¿Ya tienes una cuenta? <a href="{% url 'login' %}">Inicia sesión aquí</a></p>
        </div>

        {% if form.errors %}
        <div class="error-message visible">
            {% for field in form %}
                {% for error in field.errors %}
                    <p>{{ error }}</p>
                {% endfor %}
            {% endfor %}
        </div>
        {% endif %}

        <div id="petsContainer" style="display: none;">
            <h4>Mascotas registradas:</h4>
            <div id="petsList"></div>
        </div>
    </form>
</div>
{% endblock content %}

{% block extra_scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
    const userSection = $('#userSection');
    const petSection = $('#petSection');
    const nextBtn = $('#nextBtn');
    const prevBtn = $('#prevBtn');
    const steps = $('.step');
    const password2Input = $('input[name="password2"]');
    let pets = [];
    const addPetBtn = $('#addPetBtn');
    const petsContainer = $('#petsContainer');
    const petsList = $('#petsList');

    // Add placeholder to password confirmation
    password2Input.attr('placeholder', ' ');

    // Label positioning functionality
    $('input').on('input', function() {
        if ($(this).val().length > 0) {
            $(this).addClass('has-content');
        } else {
            $(this).removeClass('has-content');
        }
    });

    // Check on page load for any pre-filled inputs
    $('input').each(function() {
        if ($(this).val().length > 0) {
            $(this).addClass('has-content');
        }
    });

    nextBtn.click(function() {
        const password1 = $('input[name="password1"]').val();
        const password2 = password2Input.val();

        if (password1 !== password2) {
            password2Input[0].setCustomValidity('Las contraseñas no coinciden');
            password2Input.addClass('has-content');
            password2Input[0].reportValidity();
            return;
        } else {
            password2Input[0].setCustomValidity('');
        }

        const userInputs = userSection.find('input[required]');
        let isValid = true;
        
        userInputs.each(function() {
            if (!this.reportValidity()) {
                $(this).addClass('has-content');
                isValid = false;
                return false;
            }
        });

        if (isValid) {
            userSection.hide();
            petSection.show();
            steps.eq(1).addClass('active');
        }
    });

    // Enhanced password confirmation validation
    password2Input
        .on('input', function() {
            const password1 = $('input[name="password1"]').val();
            const password2 = $(this).val();
            
            $(this).addClass('has-content');
            
            if (password1 !== password2) {
                this.setCustomValidity('Las contraseñas no coinciden');
            } else {
                this.setCustomValidity('');
            }
        })
        .on('invalid', function() {
            $(this).addClass('has-content');
        })
        .on('blur focus', function() {
            $(this).addClass('has-content');
        });

    // Add Pet Button Functionality
    addPetBtn.click(function() {
        const petInputs = $('#petSection').find('input[required]');
        let isValid = true;
        
        petInputs.each(function() {
            if (!this.reportValidity()) {
                isValid = false;
                return false;
            }
        });

        if (isValid) {
            const petData = {
                name: $('input[name="pet_name"]').val(),
                species: $('input[name="species"]').val(),
                breed: $('input[name="breed"]').val(),
                age: $('input[name="age"]').val(),
                image: $('input[name="image"]')[0].files[0]
            };

            pets.push(petData);
            petsContainer.show();
            petsList.append(`<p>🐾 ${petData.name} - ${petData.species} (${petData.breed})</p>`);

            $('input[name="pet_name"]').val('').removeClass('has-content');
            $('input[name="species"]').val('').removeClass('has-content');
            $('input[name="breed"]').val('').removeClass('has-content');
            $('input[name="age"]').val('').removeClass('has-content');
            $('input[name="image"]').val('');
        }
    });

    // Form submission handling
    $('#registrationForm').on('submit', function(e) {
        e.preventDefault();
        
        // Get current pet data if fields are filled
        const currentPetData = {
            name: $('input[name="pet_name"]').val(),
            species: $('input[name="species"]').val(),
            breed: $('input[name="breed"]').val(),
            age: $('input[name="age"]').val(),
            image: $('input[name="image"]')[0].files[0]
        };

        // Add current pet to pets array if not empty
        if (currentPetData.name) {
            pets.push(currentPetData);
        }
        
        const formData = new FormData(this);
        
        pets.forEach((pet, index) => {
            formData.append(`pet_${index}_name`, pet.name);
            formData.append(`pet_${index}_species`, pet.species);
            formData.append(`pet_${index}_breed`, pet.breed);
            formData.append(`pet_${index}_age`, pet.age);
            if (pet.image) {
                formData.append(`pet_${index}_image`, pet.image);
            }
        });
        
        formData.append('pets_count', pets.length);
        
        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val()
            },
            beforeSend: function(xhr) {
                xhr.setRequestHeader('X-CSRFToken', $('input[name="csrfmiddlewaretoken"]').val());
            },
            success: function(response) {
                if (response.redirect_url) {
                    window.location.href = response.redirect_url;
                }
            }
        });
    });

    prevBtn.click(function() {
        petSection.hide();
        userSection.show();
        steps.eq(1).removeClass('active');
    });
});

</script>
{% endblock extra_scripts %}